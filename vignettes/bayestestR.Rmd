---
title: "Plotting Functions for the 'bayestestR' Package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Plotting Functions for the 'bayestestR' Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  out.width = "100%",
  warning = FALSE,
  message = FALSE
)

# `{httr}` is needed for `insight::download_model()`
pkgs <- c("bayestestR", "brms", "ggplot2", "httr", "insight", "logspline", "rstanarm")
successfully_loaded <- vapply(pkgs, requireNamespace, FUN.VALUE = logical(1L), quietly = TRUE)
can_evaluate <- all(successfully_loaded)

if (can_evaluate) {
  knitr::opts_chunk$set(eval = TRUE)
  vapply(pkgs, require, FUN.VALUE = logical(1L), quietly = TRUE, character.only = TRUE)
} else {
  knitr::opts_chunk$set(eval = FALSE)
}

options(warn = 2L)
```

This vignette can be referred to by citing the package:

```{r}
citation("see")
```

---

## Introduction

Existing R packages allow users to easily fit a large variety of models and extract and visualize the posterior draws. However, most of these packages only return a limited set of indices (e.g., point-estimates and CIs). *bayestestR* package in *easystats* provides a comprehensive and consistent set of functions to analyze and describe posterior distributions generated by a variety of models objects, including popular modeling packages such as **rstanarm**, **brms** or **BayesFactor**.

For more, see: <https://easystats.github.io/bayestestR/>

## Setup and Model Fitting

```{r setup}
library(bayestestR)
library(insight)
library(see)
library(rstanarm)
library(ggplot2)

theme_set(theme_modern())
```

```{r}
set.seed(123)
# model with fixed effects only
model <- rstanarm::stan_glm(Sepal.Length ~ Petal.Width * Species, data = iris, refresh = 0)

# model with fixed and random effects as well as zero-inflation component
model2 <- insight::download_model("brms_zi_3")
```

## Density Estimation

_([related function documentation](https://easystats.github.io/bayestestR/reference/estimate_density.html))_

Plotting density estimations of Bayesian regression models will produce plots of
the posterior distributions from model parameters, i.e. posterior interval
estimates from MCMC draws.

By default, all distributions are "stacked", i.e. overlaying each other.

```{r}
result <- estimate_density(model)

plot(result)
```

To get ridge lines separated by parameters, use `stack = FALSE`.

```{r}
plot(result, stack = FALSE)
```

### Adding Prior Samples

For many plots, when the model has defined priors, you can add a layer from the
prior distribution for the parameters with `priors = TRUE`.

```{r}
plot(result, stack = FALSE, priors = TRUE)
```

## Density Estimation of Posterior Samples from `describe_posterior()`

_([related function documentation](https://easystats.github.io/bayestestR/reference/describe_posterior.html))_

There is a convenient short cut to plot posterior samples directly from `bayestestR::describe_posterior()`, which internally calls `estimate_density()` and `plot()`:

```{r}
result <- describe_posterior(model)
plot(result)
```


## Probability of Direction (pd)

_([related function documentation](https://easystats.github.io/bayestestR/reference/p_direction.html))_

The probability of direction (also known as the maximum probability of effect -
MPE) varies between 50% and 100% (i.e., 0.5 and 1) and can be interpreted as the
probability (expressed in percentage) that a parameter (described by its
posterior distribution) is strictly positive or negative (whichever is the most
probable).

It is mathematically defined as the proportion of the posterior distribution
that is of the median's sign. Although differently expressed, this index is
fairly similar (i.e., is strongly correlated) to the frequentist p-value

```{r}
result <- p_direction(model)

result

plot(result)
```

For more complex models with different components, each component is displayed
in a separate facet. Use `n_columns` to define the layout, i.e. how many columns
are used to display the facets.

```{r fig.width=9, fig.height=9}
result <- p_direction(model2, effects = "all", component = "all")

result

plot(result)
plot(result, n_columns = NULL)
```

### Adding Prior Samples

```{r}
result <- p_direction(model)
plot(result, priors = TRUE)
```

## Practical Significance

_([related function documentation](https://easystats.github.io/bayestestR/reference/p_significance.html))_

The probability of practical significance is conceptualized as a unidirectional
equivalence test. It returns the probability that an effect is above a given
threshold corresponding to a negligible effect in the median's direction.

Mathematically, it is defined as the proportion of the posterior distribution of
the median sign above the threshold.

```{r}
result <- p_significance(model)

result

plot(result)
```

```{r fig.width=8, fig.height=10}
result <- p_significance(model2, effects = "all", component = "all", verbose = FALSE)

result

plot(result)
plot(result, n_columns = NULL)
```

### Adding Prior Samples

```{r}
result <- p_significance(model)
plot(result, priors = TRUE)
```

## Point Estimates

_([related function documentation](https://easystats.github.io/bayestestR/reference/point_estimate.html))_

`point_estimate()` computes various point-estimates, such as the mean, the
median or the MAP, to describe posterior distributions. The `plot()`-method
shows the posterior distribution of related parameters and emphasizes the point
estimate within the plot.

```{r fig.height=10}
result <- point_estimate(model)

result

plot(result)
```

```{r}
result <- point_estimate(model, centrality = c("map", "mean"))

result

plot(result, panel = FALSE)[[2]]
```

### Adding Prior Samples

```{r fig.height=10}
result <- point_estimate(model)
plot(result, priors = TRUE)
```

## Highest Density Interval (HDI)

_([related function documentation](https://easystats.github.io/bayestestR/reference/hdi.html))_

`hdi()` computes the Highest Density Interval (HDI) of posterior distributions.
All points within this interval have a higher probability density than points
outside the interval.

The HDI can be used in the context of uncertainty characterisation of posterior
distributions as Credible Interval (CI).

```{r}
result <- hdi(model, ci = c(0.5, 0.75, 0.89, 0.95))

result

plot(result) + scale_fill_flat()
```

```{r fig.width=9, fig.height=9}
result <- hdi(model2, ci = c(0.5, 0.75, 0.89), effects = "all", component = "all")

plot(result, n_columns = 2) + scale_fill_metro()
plot(result, n_columns = NULL) + scale_fill_material()
```

## Support Interval

_([related function documentation](https://easystats.github.io/bayestestR/reference/si.html))_

Plotting the result of a call to `si()` results in a plot presenting the prior
and posterior distributions for each parameter (note that by default
`show_intercept = FALSE`). The support interval will be denoted by a shaded
border.

```{r}
library(logspline) # needed for `si()`

result <- si(model)
result

plot(result) +
  scale_color_metro(palette = "ice") +
  scale_fill_metro(palette = "ice")

plot(result, support_only = TRUE) +
  scale_color_metro(palette = "ice") +
  scale_fill_metro(palette = "ice")
```

## Region of Practical Equivalence (ROPE)

_([related function documentation](https://easystats.github.io/bayestestR/reference/rope.html))_

`rope()` computes the proportion (in percentage) of the HDI of a posterior
distribution that lies within a region of practical equivalence (*ROPE*).

The related `plot()`-method plots posterior distributions, coloring different
HDI levels, and adds a "rope" region to the plot that indicates which portion of
the posterior distributions lies inside (and outside) the ROPE.

```{r}
result <- rope(model, ci = c(0.9, 0.95))

result

plot(result, rope_color = "red") +
  scale_fill_brewer(palette = "Greens", direction = -1)
```

```{r fig.width=8, fig.height=10}
result <- rope(model2, ci = c(0.9, 0.95), effects = "all", component = "all")

result

plot(result, rope_color = "grey70") +
  scale_fill_social()
```

## Test for Practical Equivalence

_([related function documentation](https://easystats.github.io/bayestestR/reference/equivalence_test.html))_

The test for practical equivalence is based on the "HDI+ROPE decision rule" to
check whether parameter values should be accepted or rejected against an
explicitly formulated "null hypothesis" (i.e., a ROPE). In other words, it
checks the percentage of the 89% HDI that is the null region (the ROPE). If this
percentage is sufficiently low, the null hypothesis is rejected. If this
percentage is sufficiently high, the null hypothesis is accepted.

```{r}
result <- equivalence_test(model)

result

plot(result) +
  theme_blackboard() +
  scale_fill_material()
```

```{r fig.width=9, fig.height=6}
result <- equivalence_test(model, ci = c(0.89, 0.95))

result

plot(result) +
  theme_abyss() +
  scale_fill_flat()
```

```{r fig.width=11, fig.height=9}
result <- equivalence_test(model2, ci = c(0.89, 0.95), effects = "all", component = "all")

result

plot(result, n_columns = 3) + theme_modern()
```

## Bayes Factors (BFs)

### Bayes Factors for Model Parameters

_([related function documentation](https://easystats.github.io/bayestestR/reference/bayesfactor_parameters.html))_

Plotting the result of a call to `bayesfactor_parameters()` results in a plot
presenting the prior and posterior distributions for each parameter (note that
by default `show_intercept = FALSE`). When a point null was tested, two dots
represent the density of the null at the value - the ratio of their heights is
the value of the Savage-Dickey Bayes factor:

```{r}
result <- bayesfactor_parameters(model)

result

plot(result) +
  scale_color_material() +
  scale_fill_material()
```

When an interval null was tested, two dashed lines mark the edges of the null
interval at the value - the Bayes factor represents the degree by which the
distribution mass of the posterior has shifted outside or inside the null
interval relative to the prior distribution:

```{r}
result <- bayesfactor_parameters(model, null = rope_range(model))

result

plot(result) +
  scale_color_material() +
  scale_fill_material()
```

### Bayes Factors for Model Comparison

_([related function documentation](https://easystats.github.io/bayestestR/reference/bayesfactor_models.html))_

```{r}
lm0 <- lm(qsec ~ 1, data = mtcars)
lm1 <- lm(qsec ~ drat, data = mtcars)
lm2 <- lm(qsec ~ wt, data = mtcars)
lm3 <- lm(qsec ~ drat + wt, data = mtcars)

result <- bayesfactor_models(lm1, lm2, lm3, denominator = lm0)

result
```

*Pizza plots* are a visual way of representing the posterior probabilities of
several models, with ratio of the areas of any two models corresponding to their
posterior odds.^[When all models are given equal prior probabilities, then all
prior odds are 1, and the posterior odds are equal to the Bayes factor.] It is
possible to plot all compared models on one (pizza) pie:

```{r}
plot(result, n_pies = "one", value = "probability") +
  scale_fill_pizza(reverse = TRUE)
```

But it is also possible to plot one pizza for each model and the denominator
model (and who doesn't like ***more*** pizza?):

```{r}
plot(result, n_pies = "many", value = "BF") +
  scale_fill_flat(palette = "rainbow", reverse = TRUE)
```
